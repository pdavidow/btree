<!doctype html>
<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500|Roboto+Mono|Roboto+Condensed:400,700&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://code.getmdl.io/1.2.0/material.teal-red.min.css" />
    </head>

    <body>
        <div id="app"></div>
        <!-- https://github.com/ohanhi/elm-taco/blob/master/index.html, https://elmlang.slack.com/archives/C0CJ3SBBM/p1498839315553233 -->
        <script src="/_compile/Main.elm"></script>
        <script>
            Elm.Main.embed(document.getElementById('app'), Math.floor(Math.random()*0x0FFFFFFF));

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            announceStartPlayNote = (id) => app.ports.port_startPlayNote.send(id);
            announceDonePlayNote = (id) => app.ports.port_donePlayNote.send(id);
            announceDonePlayNotes = () => app.ports.port_donePlayNotes.send(true);


            app.ports.port_playNote.subscribe((note) => {
                console.log ("port_playNote note", note);

                const {freq, id, startOffset, duration, isLast} = note;
                const soundOscillator = audioContext.createOscillator();
                const silentOscillator = audioContext.createOscillator(); // hack for lack of .onstarted, start sound shifted to compensate
                const timeShift = 0.05; //sec
                const currentTime = audioContext.currentTime;
                const silentStartTime = currentTime + startOffset; // sec
                const silentStopTime = silentStartTime + timeShift; // sec
                const soundStartTime = silentStopTime; // sec
                const soundStopTime = soundStartTime + duration; // sec

                soundOscillator.connect(audioContext.destination);
                soundOscillator.frequency.value = freq;

                silentOscillator.connect(audioContext.destination);
                silentOscillator.frequency.value = 0; //silence


                silentOscillator.onended = () => announceStartPlayNote(id);

                if (isLast) {
                    soundOscillator.onended = () => {
                        announceDonePlayNote(id);
                        announceDonePlayNotes();
                    };
                } else {
                    soundOscillator.onended = () => announceDonePlayNote(id);
                }

                silentOscillator.start(silentStartTime);
                silentOscillator.stop (silentStopTime);
                soundOscillator.start(soundStartTime);
                soundOscillator.stop (soundStopTime);
            });
        </script>
    </body>
</html>