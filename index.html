<!doctype html>
<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500|Roboto+Mono|Roboto+Condensed:400,700&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://code.getmdl.io/1.2.0/material.teal-red.min.css" />
    </head>

    <body>
        <div id="elm-area"></div>

        <script src="elm.js"></script>
        <script>
            const app = Elm.Main.fullscreen();
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            announceDonePlayNotes = function() {
                app.ports.port_donePlayNotes.send(true);
            };

            app.ports.port_playNote.subscribe(function (note) {
                console.log ("port_playNote note", note);

                const {freq, startOffset, stopOffset, onEnded} = note;
                const oscillator = audioContext.createOscillator();
                let currentTime;

                oscillator.connect(audioContext.destination);
                oscillator.frequency.value = freq;
                if (onEnded) oscillator.onended = announceDonePlayNotes;

                currentTime = audioContext.currentTime;
                oscillator.start(currentTime + startOffset); // sec
                oscillator.stop (currentTime + stopOffset); // sec
            });
        </script>
    </body>
</html>