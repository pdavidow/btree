<!doctype html>
<html>
    <head>
        <link href='https://fonts.googleapis.com/css?family=Roboto:400,300,500|Roboto+Mono|Roboto+Condensed:400,700&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://code.getmdl.io/1.2.0/material.teal-red.min.css" />
    </head>

    <body>
        <div id="elm-area"></div>

        <script src="elm.js"></script>
        <script>
            const app = Elm.Main.fullscreen(Math.floor(Math.random()*0x0FFFFFFF));
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            announceDonePlayNote = (id) => app.ports.port_donePlayNote.send(id);
            announceDonePlayNotes = () => app.ports.port_donePlayNotes.send(true);


            app.ports.port_playNote.subscribe((note) => {
                console.log ("port_playNote note", note);

                const {freq, id, startOffset, stopOffset, isLast} = note;
                const oscillator = audioContext.createOscillator();
                let currentTime;

                oscillator.connect(audioContext.destination);
                oscillator.frequency.value = freq;


                if (isLast) {
                    oscillator.onended = () => {
                        announceDonePlayNote(id);
                        announceDonePlayNotes();
                    };
                } else {
                    oscillator.onended = () => announceDonePlayNote(id);
                }

                currentTime = audioContext.currentTime;
                oscillator.start(currentTime + startOffset); // sec
                oscillator.stop (currentTime + stopOffset); // sec
            });
        </script>
    </body>
</html>